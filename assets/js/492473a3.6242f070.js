"use strict";(self.webpackChunkmomento_docs=self.webpackChunkmomento_docs||[]).push([[6425],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>d});var a=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=a.createContext({}),p=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=p(e.components);return a.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,r=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),h=p(n),d=o,m=h["".concat(l,".").concat(d)]||h[d]||u[d]||r;return n?a.createElement(m,i(i({ref:t},c),{},{components:n})):a.createElement(m,i({ref:t},c))}));function d(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=n.length,i=new Array(r);i[0]=h;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:o,i[1]=s;for(var p=2;p<r;p++)i[p]=n[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},730:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>u,frontMatter:()=>r,metadata:()=>s,toc:()=>p});var a=n(7462),o=(n(7294),n(3905));const r={sidebar_position:9,sidebar_label:"Fastly",title:"Integrating Momento Cache with Fastly Compute@Edge",description:"Learn to deploy a Fastly Compute@Edge project that uses Momento Cache via HTTP API."},i=void 0,s={unversionedId:"cache/develop/integrations/fastly",id:"cache/develop/integrations/fastly",title:"Integrating Momento Cache with Fastly Compute@Edge",description:"Learn to deploy a Fastly Compute@Edge project that uses Momento Cache via HTTP API.",source:"@site/docs/cache/develop/integrations/fastly.md",sourceDirName:"cache/develop/integrations",slug:"/cache/develop/integrations/fastly",permalink:"/cache/develop/integrations/fastly",draft:!1,editUrl:"https://github.com/momentohq/public-dev-docs/tree/main/docs/cache/develop/integrations/fastly.md",tags:[],version:"current",sidebarPosition:9,frontMatter:{sidebar_position:9,sidebar_label:"Fastly",title:"Integrating Momento Cache with Fastly Compute@Edge",description:"Learn to deploy a Fastly Compute@Edge project that uses Momento Cache via HTTP API."},sidebar:"tutorialSidebar",previous:{title:"Cloudflare",permalink:"/cache/develop/integrations/cloudflare"},next:{title:"Deno",permalink:"/cache/develop/integrations/deno"}},l={},p=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Momento Setup",id:"momento-setup",level:3},{value:"Fastly Setup",id:"fastly-setup",level:3},{value:"Deploying with Fastly",id:"deploying-with-fastly",level:2},{value:"Conclusion",id:"conclusion",level:2}],c={toc:p};function u(e){let{components:t,...r}=e;return(0,o.kt)("wrapper",(0,a.Z)({},c,r,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://www.fastly.com/products/edge-compute"},"Compute@Edge")," is Fastly's platform for deploying and running serverless code."),(0,o.kt)("p",null,"In this tutorial, we'll walk through the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/momentohq/client-sdk-javascript/tree/main/examples/fastly-compute"},"example")," from our ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/momentohq/client-sdk-javascript"},"JavaScript SDK"),". By the end of the exercise, you'll have a Fastly Compute@Edge project that interacts with Momento Cache via the HTTP API to get, set, and delete some data."),(0,o.kt)("p",null,"The HTTP API is lightweight in that you won't need any additional dependencies beyond what Fastly requires and you can use the standard ",(0,o.kt)("inlineCode",{parentName:"p"},"fetch")," HTTP client methods. However, it only provides a basic subset of all of the Momento APIs, such as ",(0,o.kt)("inlineCode",{parentName:"p"},"get"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"set"),", and ",(0,o.kt)("inlineCode",{parentName:"p"},"delete"),", and is currently only available if you use AWS as your cloud provider."),(0,o.kt)("h2",{id:"prerequisites"},"Prerequisites"),(0,o.kt)("p",null,"To get this app deployed and running, you'll need to have the following:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"An account with a Git provider such as ",(0,o.kt)("a",{parentName:"li",href:"https://github.com/"},"GitHub"),", ",(0,o.kt)("a",{parentName:"li",href:"https://gitlab.com"},"GitLab"),", or ",(0,o.kt)("a",{parentName:"li",href:"https://bitbucket.org/"},"Bitbucket"),"."),(0,o.kt)("li",{parentName:"ul"},"A ",(0,o.kt)("a",{parentName:"li",href:"https://www.fastly.com/"},"Fastly")," account."),(0,o.kt)("li",{parentName:"ul"},"A copy or fork of the ",(0,o.kt)("a",{parentName:"li",href:"https://github.com/momentohq/client-sdk-javascript"},"Momento JavaScript SDK")," in your personal repositories.")),(0,o.kt)("h3",{id:"momento-setup"},"Momento Setup"),(0,o.kt)("p",null,"Once you have a copy or fork of the Momento JavaScript SDK in your Git provider account, you're ready to configure the Momento side of things using the ",(0,o.kt)("a",{parentName:"p",href:"https://console.gomomento.com"},"Momento console"),". You can create an account in the console by providing your email address or linking an existing Google or GitHub account. Once you've logged into the console, click the ",(0,o.kt)("inlineCode",{parentName:"p"},"Create Cache")," button on the top right of the page:"),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Create Cache button",src:n(9111).Z,width:"336",height:"258"})),(0,o.kt)("p",null,"Create a cache called ",(0,o.kt)("inlineCode",{parentName:"p"},"worker")," using AWS. Currently, the Momento HTTP API is supported only by AWS, but you can create the cache in any of the supported AWS regions."),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Create cache form",src:n(1423).Z,width:"1920",height:"694"})),(0,o.kt)("p",null,"After pressing the ",(0,o.kt)("inlineCode",{parentName:"p"},"Create")," button you'll see the new ",(0,o.kt)("inlineCode",{parentName:"p"},"worker")," cache in the list of available caches."),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"New cache",src:n(6546).Z,width:"1916",height:"472"})),(0,o.kt)("p",null,"Notice the region you created your cache in is also displayed in the list of caches. You'll need to make sure that you choose the same region when generating a Momento authentication token in the next step. "),(0,o.kt)("p",null,"Navigate to the ",(0,o.kt)("a",{parentName:"p",href:"https://console.gomomento.com/tokens"},"tokens")," page, and choose the cloud provider and region you used to create your cache. Since the cache is already created, we will use a fine-grained token that will allow the worker to read from and write to the cache; but will not allow it to do control plane operations, such as creating or deleting a cache. This is especially helpful if you want to manage the security of control plane and data plane operations separately."),(0,o.kt)("p",null,"Choose the ",(0,o.kt)("inlineCode",{parentName:"p"},"Fine-Grained Access Token")," token type, select ",(0,o.kt)("inlineCode",{parentName:"p"},"worker")," as ",(0,o.kt)("inlineCode",{parentName:"p"},"Cache Name")," from the drop down, and ",(0,o.kt)("inlineCode",{parentName:"p"},"readwrite")," as ",(0,o.kt)("inlineCode",{parentName:"p"},"Role Type"),". The ",(0,o.kt)("inlineCode",{parentName:"p"},"Super User Token")," is used for managing control plane operations. More information about Momento authentication can be found ",(0,o.kt)("a",{parentName:"p",href:"/cache/develop/authentication/"},"here"),". Hit the ",(0,o.kt)("inlineCode",{parentName:"p"},"Generate Token")," button."),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Generate token",src:n(6953).Z,width:"3448",height:"1916"})),(0,o.kt)("p",null,"Copy the ",(0,o.kt)("inlineCode",{parentName:"p"},"Auth Token")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"HTTP Endpoint")," and save it in a safe place. You'll need to use it later to configure your Fastly Compute@Edge deployment."),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Generated token",src:n(5610).Z,width:"1679",height:"174"})),(0,o.kt)("h3",{id:"fastly-setup"},"Fastly Setup"),(0,o.kt)("p",null,"Once you have created your Fastly account, you're ready to configure the Fastly side of things using the ",(0,o.kt)("a",{parentName:"p",href:"https://manage.fastly.com/services/all"},"Fastly console"),". Once you're logged in, click on your account name in the top right corner and select ",(0,o.kt)("inlineCode",{parentName:"p"},"Account"),". Under the ",(0,o.kt)("inlineCode",{parentName:"p"},"Personal profile")," section of the side bar, select ",(0,o.kt)("inlineCode",{parentName:"p"},"API tokens"),". Click on the ",(0,o.kt)("inlineCode",{parentName:"p"},"Create Token")," button in the top right and follow Fastly's instructions for creating a ",(0,o.kt)("a",{parentName:"p",href:"https://docs.fastly.com/en/guides/using-api-tokens#creating-api-tokens"},"user API token"),". Make sure to save this API token in a safe place."),(0,o.kt)("p",null,"Next, you will install the ",(0,o.kt)("a",{parentName:"p",href:"https://developer.fastly.com/learning/compute/#install-the-fastly-cli"},"Fastly CLI")," and follow the command line prompts for providing the API token you just created:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"brew install fastly/tap/fastly\nfastly profile create\n")),(0,o.kt)("h2",{id:"deploying-with-fastly"},"Deploying with Fastly"),(0,o.kt)("p",null,"Now it's time to configure and deploy the application to your Fastly account. As noted before, you need a copy of the Momento JavaScript SDK available in your repository.\nIn this example, we'll deploy from a GitHub repository forked from ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/momentohq/client-sdk-javascript"},"the original"),"."),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Fork SDK Repository",src:n(9734).Z,width:"2478",height:"84"})),(0,o.kt)("p",null,"This repository contains a directory under ",(0,o.kt)("inlineCode",{parentName:"p"},"examples")," for ",(0,o.kt)("inlineCode",{parentName:"p"},"fastly-compute")," which contains the example code for interacting with your Momento Cache using the Momento HTTP API. "),(0,o.kt)("p",null,"Fastly Compute@Edge uses a file called ",(0,o.kt)("inlineCode",{parentName:"p"},"fastly.toml")," to configure the local and deployed execution environments for your edge code. More information about Compute@Edge configuration can be found ",(0,o.kt)("a",{parentName:"p",href:"https://developer.fastly.com/reference/compute/fastly-toml/"},"on their website"),"."),(0,o.kt)("p",null,"First let's navigate to the relevant example directory and install the dependencies:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"cd client-sdk-javascript/examples/fastly-compute\nnpm install\n")),(0,o.kt)("p",null,"Second, create a ",(0,o.kt)("inlineCode",{parentName:"p"},"secrets.json")," file with the following contents:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'{\n    "MOMENTO_HTTP_ENDPOINT": "<YOUR-HTTP-ENDPOINT>",\n    "MOMENTO_BACKEND": "<YOUR-MOMENTO-BACKEND-NAME>",\n    "MOMENTO_CACHE": "<YOUR-CACHE-NAME>",\n    "MOMENTO_TOKEN": "<YOUR-MOMENTO-AUTH-TOKEN>\n}\n')),(0,o.kt)("p",null,"You can set the variable ",(0,o.kt)("inlineCode",{parentName:"p"},"MOMENTO_BACKEND")," to any string value. Make sure that your HTTP endpoint corresponds to the region where you created your Momento Cache. This is the HTTP endpoint value we copied from the Generate Token output on the Momento Console."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Note"),": for production environments, the Momento auth token should be saved in a ",(0,o.kt)("a",{parentName:"p",href:"https://developer.fastly.com/reference/api/services/resources/secret-store/"},"Fastly Secret Store"),". However, this is a feature currently restricted to beta users, so this example saves the auth token in a ",(0,o.kt)("a",{parentName:"p",href:"https://developer.fastly.com/reference/api/services/resources/config-store/"},"Config Store")," along with the other values specified in the ",(0,o.kt)("inlineCode",{parentName:"p"},"secrets.json")," file."),(0,o.kt)("p",null,"Next, you'll want to make sure the contents of your ",(0,o.kt)("inlineCode",{parentName:"p"},"secrets.json")," file match the contents in the ",(0,o.kt)("inlineCode",{parentName:"p"},"fastly.toml")," file. "),(0,o.kt)("p",null,"Specifically, you'll want to make sure your HTTP endpoint and backend name is provided under the ",(0,o.kt)("inlineCode",{parentName:"p"},"[local_server]")," heading. The local execution environment will use the information supplied under this heading to set up the appropriate backend and config store for your localhost server while you're developing."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'[local_server]\n\n  [local_server.backends]\n\n    [local_server.backends.<YOUR-MOMENTO-BACKEND-NAME>]\n      url = "https://<YOUR-HTTP-ENDPOINT>"\n\n  [local_server.config_stores]\n\n    [local_server.config_stores.secrets]\n      file = "secrets.json"\n      format = "json"\n')),(0,o.kt)("p",null,"Finally, you'll want to make sure all four variables in the ",(0,o.kt)("inlineCode",{parentName:"p"},"secrets.json")," file are copied over to the items under the ",(0,o.kt)("inlineCode",{parentName:"p"},"[setup]")," heading. Fastly will use the information supplied under this heading to create and initialize the appropriate backend and config store resources in the execution environment. "),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'[setup]\n\n  [setup.backends]\n\n    [setup.backends.<YOUR-MOMENTO-BACKEND-NAME>]\n      address = "<YOUR-HTTP-ENDPOINT>"\n      port = 443\n\n  [setup.config_stores]\n\n    [setup.config_stores.secrets]\n\n      [setup.config_stores.secrets.items]\n\n        [setup.config_stores.secrets.items.MOMENTO_BACKEND]\n          value = "<YOUR-MOMENTO-BACKEND-NAME>"\n\n        [setup.config_stores.secrets.items.MOMENTO_CACHE]\n          value = "<YOUR-CACHE-NAME>"\n\n        [setup.config_stores.secrets.items.MOMENTO_HTTP_ENDPOINT]\n          value = "<YOUR-HTTP-ENDPOINT>"\n\n        [setup.config_stores.secrets.items.MOMENTO_TOKEN]\n          value = "<YOUR-MOMENTO-AUTH-TOKEN>"\n')),(0,o.kt)("p",null,"Next, start the development server and navigate to ",(0,o.kt)("a",{parentName:"p",href:"http://localhost:7676"},"localhost:7676")," to check that it's working."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"fastly compute serve\n")),(0,o.kt)("p",null,"The code in this example sets an item in the cache, gets it, deletes it, and returns an HTML response.\nIt uses the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/momentohq/client-sdk-javascript/blob/main/examples/fastly-compute/src/index.ts#L98"},(0,o.kt)("inlineCode",{parentName:"a"},"MomentoFetcher")," class")," which provides a small wrapper that adds some error handling to the basic fetch calls to the Momento HTTP API."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"    const momento = new MomentoFetcher(authToken, httpEndpoint, backend);\n\n    const getResp = await momento.get(cacheName, key);\n    console.log(`Fetching the key when the cache is empty: ${getResp}`);\n\n    await momento.set(cacheName, key, value, 10);\n    console.log(`Set the key-value pair in the cache ${cacheName}`);\n\n    const getRespAfterSet = await momento.get(cacheName, key);\n    console.log(`Fetching the key after setting the value: ${getRespAfterSet}`);\n\n    await momento.delete(cacheName, key);\n    console.log(`Deleted the key-value pair from the cache ${cacheName}`);\n\n    return new Response(`Tested the Momento cache using: <br /> Key: ${key} | Value: ${value}`, {\n      status: 200,\n      headers: new Headers({'Content-Type': 'text/html; charset=utf-8'}),\n    });\n")),(0,o.kt)("p",null,"What you should see is a simple text response that matches: "),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Fastly example response",src:n(8093).Z,width:"482",height:"110"})),(0,o.kt)("p",null,"When you're ready to run the project on Fastly, run this command to build and deploy:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"fastly compute publish\n")),(0,o.kt)("p",null,"If you want to see logs from your deployed service, you can enable log tailing from the same directory where the ",(0,o.kt)("inlineCode",{parentName:"p"},"fastly.toml")," lives:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"fastly log-tail\n")),(0,o.kt)("p",null," More information about deploying to Fastly can be ",(0,o.kt)("a",{parentName:"p",href:"https://developer.fastly.com/learning/compute/#deploy-to-a-fastly-service"},"found here"),". And more information about logging and monitoring your Fastly Compute@Edge project can be ",(0,o.kt)("a",{parentName:"p",href:"https://developer.fastly.com/learning/compute/testing/#live-log-monitoring-in-your-console"},"found here"),"."),(0,o.kt)("h2",{id:"conclusion"},"Conclusion"),(0,o.kt)("p",null,"We hope this quick tutorial has given you an idea of how simple and straightforward it is to deploy a Momento-powered application with Fastly Compute@Edge. Feel free, of course, to dive into the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/momentohq/client-sdk-javascript/tree/main/examples/fastly-compute"},"example code")," as well. We hope you'll also enjoy the simplicity of Momento Cache, as you don't have to manage and provision any infrastructure to get up and running."))}u.isMDXComponent=!0},6546:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/console-caches-worker-f6fe32f41cabf1c18025d4d7e0862f04.png"},9111:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/console-create-cache-90d89709336a49153da1d5b47282742a.png"},1423:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/console-create-worker-cache-form-25675fe8e7d0bc42ae1673e102922af3.png"},8093:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/deployed-fastly-response-0550b74b1ca6e6a86264ad0b78a5727f.png"},6953:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/fgac-worker-auth-af9973e1c699bfcaba61714a2e6feb7e.png"},9734:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/github-fork-js-sdk-3950285fbebfdc6a75982998d63e70d6.png"},5610:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/http-endpoint-auth-token-15c123b5fd7ee29f4fd248dfa886ad57.png"}}]);